<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>stock</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      @font-face {
        font-family: "NEXON Lv1 Gothic OTF";
        src: url("https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@2.1/NEXON Lv1 Gothic OTF.woff")
          format("woff");
        font-weight: normal;
        font-style: normal;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "NEXON Lv1 Gothic OTF", sans-serif;
        font-weight: 300;
      }
      body {
        height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      main {
        display: flex;
        width: 1500px;
        height: 800px;
        border: 1px solid black;
      }

      #orderbook {
        width: 40%;
      }

      #order {
        background-color: azure;
        width: 20%;
        border-right: 1px solid black;
        border-left: 1px solid black;
      }

      #my {
        width: 40%;
      }

      #title {
        width: 1500px;
      }

      .order_box {
        padding: 13px 20px;
      }

      .order_box input {
        border: none;
        border-radius: 10px;
        width: 250px;
        height: 30px;
        padding: 10px;
      }

      .order_box form p {
        padding: 10px 0;
      }

      .submit_button {
        margin: 15px 0;
        width: 250px;
        height: 25px;
        border: none;
      }

      .order_menu {
        display: flex;
        font-size: 25px;
        gap: 30px;
      }

      #orderbook_info {
        padding: 15px 30px;
        height: 6%;
        border-bottom: 1px solid black;
        display: flex;
        align-items: center;
      }

      #orderbook_info p {
        font-size: 30px;
      }

      #BAprice {
        margin-left: 100px;
        margin-right: 10px;
      }

      td {
        border: 1px solid black;
      }

      #sell_ho {
        height: 47%;
        display: flex;
      }

      #buy_ho {
        display: flex;
        height: 47%;
      }

      .ho {
        display: flex;
        height: 37.5px;
        align-items: center;
        border-bottom: 1px solid rgb(182, 182, 182);
      }

      .ho p {
        font-size: 20px;
      }

      .ho div {
        height: 100%;
        display: flex;
        align-items: center;
      }

      .ho div:nth-child(1) {
        width: 37%;
        border-right: 1px solid rgb(182, 182, 182);
        justify-content: right;
        padding-right: 10px;
      }

      .ho div:nth-child(2) {
        width: 20%;
        justify-content: center;
      }

      .ho div:nth-child(2) p {
        font-size: 17px;
      }

      .ho div:nth-child(3) {
        border-left: 1px solid rgb(182, 182, 182);
        justify-content: center;
        width: 43%;
      }

      /**/

      .ho2 {
        display: flex;
        height: 37.5px;
        align-items: center;
        border-top: 1px solid rgb(182, 182, 182);
      }

      .ho2 p {
        font-size: 20px;
      }

      .ho2 div {
        height: 100%;
        display: flex;
        align-items: center;
      }

      .ho2 div:nth-child(1) {
        width: 43%;
        border-right: 1px solid rgb(182, 182, 182);
        justify-content: center;
      }

      .ho2 div:nth-child(2) {
        width: 20%;
        justify-content: center;
      }

      .ho2 div:nth-child(2) p {
        font-size: 17px;
      }

      .ho2 div:nth-child(3) {
        width: 37%;
        padding-left: 10px;
        justify-content: left;
        border-left: 1px solid rgb(182, 182, 182);
      }

      #info {
        border-left: 1px solid rgb(182, 182, 182);
        height: 100%;
        width: 40%;
      }

      #match {
        border-right: 1px solid rgb(182, 182, 182);
        height: 100%;
        width: 40%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        position: relative;
        overflow: scroll;
        overflow-x: hidden;
        top: 3px;
      }

      #match ul {
        height: 100%;
        list-style: none;
        text-align: center;
        font-size: 20px;
        padding: 5px;
      }

      #match li {
        height: 36.5px;
        text-align: left;
      }

      #match li span {
        padding: 0 20px;
      }

      #s_h {
        height: 100%;
        width: 70%;
        background: linear-gradient(
          to top,
          #ffffff,
          #e3eaf6
        ); /* 위에서 아래로 */
      }

      #b_h {
        width: 70%;
        background: linear-gradient(
          to bottom,
          #ffffff,
          #f6e3e3
        ); /* 위에서 아래로 */
      }
      #account {
        height: 50%;
        width: 100%;
        padding: 16px;
        box-sizing: border-box;
        padding: 0;
      }

      #match_order {
        height: 50%;
        width: 100%;
        padding: 16px;
        box-sizing: border-box;
      }

      /* 테이블 전체 스타일 */
      #account-table {
        width: 100%;
        border-collapse: collapse;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        text-align: center;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      /* 헤더 스타일 */
      #account-table thead {
        background-color: #004080;
        color: white;
      }

      #account-table thead th {
        padding: 12px 8px;
        border: 1px solid #ddd;
      }

      /* 바디 스타일 */
      #account-table tbody td {
        padding: 10px 8px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
      }

      /* 홀수행 배경색 */
      #account-table tbody tr:nth-child(odd) td {
        background-color: #f1f7ff;
      }

      /* 호버 시 강조 */
      #account-table tbody tr:hover td {
        background-color: #d0e7ff;
        transition: background-color 0.2s;
      }
    </style>
  </head>
  <body>
    <div id="title">
      <h1></h1>
    </div>
    <main>
      <div id="orderbook">
        <div id="orderbook_info">
          <p id="price"></p>
          <p id="arrow"></p>
          <p id="BAprice"></p>
          <p id="per"></p>
        </div>
        <div id="sell_ho">
          <div id="s_h">
            <div id="s_h_10" class="ho">
              <div><p id="s_h_10_j"></p></div>
              <div><p id="s_h_10_per"></p></div>
              <div><p id="s_h_10_price"></p></div>
            </div>
            <div id="s_h_9" class="ho">
              <div><p id="s_h_9_j"></p></div>
              <div><p id="s_h_9_per"></p></div>
              <div><p id="s_h_9_price"></p></div>
            </div>
            <div id="s_h_8" class="ho">
              <div><p id="s_h_8_j"></p></div>
              <div><p id="s_h_8_per"></p></div>
              <div><p id="s_h_8_price"></p></div>
            </div>
            <div id="s_h_7" class="ho">
              <div><p id="s_h_7_j"></p></div>
              <div><p id="s_h_7_per"></p></div>
              <div><p id="s_h_7_price"></p></div>
            </div>
            <div id="s_h_6" class="ho">
              <div><p id="s_h_6_j"></p></div>
              <div><p id="s_h_6_per"></p></div>
              <div><p id="s_h_6_price"></p></div>
            </div>
            <div id="s_h_5" class="ho">
              <div><p id="s_h_5_j"></p></div>
              <div><p id="s_h_5_per"></p></div>
              <div><p id="s_h_5_price"></p></div>
            </div>
            <div id="s_h_4" class="ho">
              <div><p id="s_h_4_j"></p></div>
              <div><p id="s_h_4_per"></p></div>
              <div><p id="s_h_4_price"></p></div>
            </div>
            <div id="s_h_3" class="ho">
              <div><p id="s_h_3_j"></p></div>
              <div><p id="s_h_3_per"></p></div>
              <div><p id="s_h_3_price"></p></div>
            </div>
            <div id="s_h_2" class="ho">
              <div><p id="s_h_2_j"></p></div>
              <div><p id="s_h_2_per"></p></div>
              <div><p id="s_h_2_price"></p></div>
            </div>
            <div id="s_h_1" class="ho">
              <div><p id="s_h_1_j"></p></div>
              <div><p id="s_h_1_per"></p></div>
              <div><p id="s_h_1_price"></p></div>
            </div>
          </div>
          <div id="info"></div>
        </div>
        <div id="buy_ho">
          <div id="match">
            <ul></ul>
          </div>
          <div id="b_h">
            <div id="b_h_1" class="ho2">
              <div><p id="b_h_1_price"></p></div>
              <div><p id="b_h_1_per"></p></div>
              <div><p id="b_h_1_j"></p></div>
            </div>
            <div id="b_h_2" class="ho2">
              <div><p id="b_h_2_price"></p></div>
              <div><p id="b_h_2_per"></p></div>
              <div><p id="b_h_2_j"></p></div>
            </div>
            <div id="b_h_3" class="ho2">
              <div><p id="b_h_3_price"></p></div>
              <div><p id="b_h_3_per"></p></div>
              <div><p id="b_h_3_j"></p></div>
            </div>
            <div id="b_h_4" class="ho2">
              <div><p id="b_h_4_price"></p></div>
              <div><p id="b_h_4_per"></p></div>
              <div><p id="b_h_4_j"></p></div>
            </div>
            <div id="b_h_5" class="ho2">
              <div><p id="b_h_5_price"></p></div>
              <div><p id="b_h_5_per"></p></div>
              <div><p id="b_h_5_j"></p></div>
            </div>
            <div id="b_h_6" class="ho2">
              <div><p id="b_h_6_price"></p></div>
              <div><p id="b_h_6_per"></p></div>
              <div><p id="b_h_6_j"></p></div>
            </div>
            <div id="b_h_7" class="ho2">
              <div><p id="b_h_7_price"></p></div>
              <div><p id="b_h_7_per"></p></div>
              <div><p id="b_h_7_j"></p></div>
            </div>
            <div id="b_h_8" class="ho2">
              <div><p id="b_h_8_price"></p></div>
              <div><p id="b_h_8_per"></p></div>
              <div><p id="b_h_8_j"></p></div>
            </div>
            <div id="b_h_9" class="ho2">
              <div><p id="b_h_9_price"></p></div>
              <div><p id="b_h_9_per"></p></div>
              <div><p id="b_h_9_j"></p></div>
            </div>
            <div id="b_h_10" class="ho2">
              <div><p id="b_h_10_price"></p></div>
              <div><p id="b_h_10_per"></p></div>
              <div><p id="b_h_10_j"></p></div>
            </div>
          </div>
        </div>
      </div>
      <div id="order">
        <div class="order_box">
          <div class="order_menu">
            <div>BUY</div>
            <div>SELL</div>
          </div>
          <div>
            <form action="">
              <p>StockId</p>
              <input type="text" value="1" disabled />
              <p>AccountNumber</p>
              <input type="text" />
              <p>Number</p>
              <input type="text" />
              <p>Price</p>
              <input type="text" />
              <button class="submit_button">submit</button>
            </form>
          </div>
        </div>
        <div class="order_box">
          <div class="order_menu">
            <div>EDIT</div>
            <div>CANCELL</div>
          </div>
          <div>
            <form action="">
              <p>StockId</p>
              <input type="text" value="1" disabled />
              <p>AccountNumber</p>
              <input type="text" disabled />
              <p>Number</p>
              <input type="text" disabled />
              <p>Price</p>
              <input type="text" disabled />
              <button class="submit_button" disabled>submit</button>
            </form>
          </div>
        </div>
      </div>
      <div id="my">
        <div id="account">
          <table id="account-table">
            <thead>
              <tr>
                <th>종목명</th>
                <th>평가손익</th>
                <th>수익률</th>
                <th>평균단가</th>
                <th>수량</th>
                <th>가능수량</th>
                <th>현재가</th>
                <th>총 매입 금액</th>
              </tr>
            </thead>
            <tbody>
              <!-- 자바스크립트로 내용 추가됨 -->
            </tbody>
          </table>
        </div>
        <div id="match_order"></div>
      </div>
    </main>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
      const socket = io("http://localhost:3003/stock", {
        transportOptions: {
          polling: {
            extraHeaders: {
              Authorization:
                "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjMsInVzZXJuYW1lIjoiYWRtaW4zIiwiaWF0IjoxNzQ3MzE0NDY1fQ.Tq0XFy1HJY-Ict4BLVUGgMHizoZn45JmQ4f5PKl1WuY",
            },
          },
        },
      });

      socket.on("connect", () => {
        console.log("서버에 연결되었습니다.");
      });

      socket.emit("joinStockRoom", 1);
      socket.emit("joinAccountRoom");
      // 서버로부터 주식 업데이트 수신
      socket.on("stockUpdated", (data) => {
        updateStockInfo(data.stockInfo);
        updateOrderBook(data.buyorderbookData, data.sellorderbookData);
        fillMatchData(data.match);
      });

      socket.on("accountUpdated", (data) => {
        console.log(data)
        renderAccountTable(data);
      });

      socket.on("error_custom", (data) => {
        console.error("서버 에러 수신:", data.message);
        alert(data.message); // 사용자에게 안내
      });

      function renderAccountTable(data) {
        const tableBody = document.querySelector("#account-table tbody");

        // 기존 내용 제거
        tableBody.innerHTML = "";

        data.forEach((item) => {
          const row = document.createElement("tr");

          // 종목명
          const nameCell = document.createElement("td");
          nameCell.textContent = item.name;

          // 평가손익 = (현재가 - 평균단가) * 수량
          const profitLoss = (item.nowPrice - item.average) * item.amount;
          const profitLossCell = document.createElement("td");
          profitLossCell.textContent = profitLoss.toLocaleString();
          profitLossCell.style.color = profitLoss > 0 ? "red" : profitLoss < 0 ? "blue" : "black";

          // 수익률 = ((현재가 - 평균단가) / 평균단가) * 100
          const returnRate = item.average !== 0 ? ((item.nowPrice - item.average) / item.average) * 100 : 0;
          const returnRateCell = document.createElement("td");
          returnRateCell.textContent = returnRate.toFixed(2) + "%";
          returnRateCell.style.color = returnRate > 0 ? "red" : returnRate < 0 ? "blue" : "black";

          // 평균단가
          const averageCell = document.createElement("td");
          averageCell.textContent = item.average.toLocaleString();

          // 수량
          const amountCell = document.createElement("td");
          amountCell.textContent = item.amount.toLocaleString();

          // 가능수량
          const canAmountCell = document.createElement("td");
          canAmountCell.textContent = item.canAmount.toLocaleString();

          // 현재가
          const nowPriceCell = document.createElement("td");
          nowPriceCell.textContent = item.nowPrice.toLocaleString();

          // 총 매입 금액
          const totalBuyAmountCell = document.createElement("td");
          totalBuyAmountCell.textContent = Number(item.totalBuyAmount).toLocaleString();

          // 행에 셀 추가 (헤더 순서에 맞춰)
          row.appendChild(nameCell);
          row.appendChild(profitLossCell);
          row.appendChild(returnRateCell);
          row.appendChild(averageCell);
          row.appendChild(amountCell);
          row.appendChild(canAmountCell);
          row.appendChild(nowPriceCell);
          row.appendChild(totalBuyAmountCell);

          // 테이블에 행 추가
          tableBody.appendChild(row);
        });
      }


      function updateStockInfo(stockInfo) {
        const priceElement = document.getElementById("price");
        const arrowElement = document.getElementById("arrow");
        const percentElement = document.getElementById("per");
        const BApriceElement = document.getElementById("BAprice"); // 대비 금액 요소 추가
        const price = stockInfo.price; // 주식 가격
        const referencePrice = 9500; // 기준 가격

        document.getElementById("price").textContent = " ";
        document.getElementById("arrow").textContent = " ";
        document.getElementById("per").textContent = " ";
        document.getElementById("BAprice").textContent = " "; // 대비 금액 요소 추가

        priceElement.textContent = price;
        document.querySelector("h1").textContent = stockInfo.name;

        // 가격 변화에 따른 색상 및 화살표 업데이트
        const difference = price - referencePrice; // 대비 금액 계산

        if (price > referencePrice) {
          priceElement.style.color = "#FF0000"; // 빨간색
          percentElement.style.color = "#FF0000";
          arrowElement.textContent = "▲"; // 상승 화살표
          arrowElement.style.color = "#FF0000"; // 화살표 색상
          percentElement.textContent =
            "+" + ((difference / referencePrice) * 100).toFixed(2) + "%"; // 상승 퍼센트
          BApriceElement.textContent = difference; // 대비 금액 표시 (원 제거)
          BApriceElement.style.color = "#FF0000"; // 대비 금액 색상
        } else if (price < referencePrice) {
          priceElement.style.color = "#0055FF"; // 파란색
          percentElement.style.color = "#0055FF";
          arrowElement.textContent = "▼"; // 하락 화살표
          arrowElement.style.color = "#0055FF"; // 화살표 색상
          percentElement.textContent =
            "-" + ((-difference / referencePrice) * 100).toFixed(2) + "%"; // 하락 퍼센트
          BApriceElement.textContent = difference; // 대비 금액 표시 (원 제거)
          BApriceElement.style.color = "#0055FF"; // 대비 금액 색상
        } else {
          priceElement.style.color = "#000000"; // 검은색
          percentElement.style.color = "#000000";
          arrowElement.textContent = "-"; // 변화 없음 화살표
          arrowElement.style.color = "#000000"; // 화살표 색상
          percentElement.textContent = "0.00%"; // 변화 없음 퍼센트
          BApriceElement.textContent = "0"; // 대비 금액 표시 (원 제거)
          BApriceElement.style.color = "#000000"; // 대비 금액 색상
        }
      }
      //
      function updateOrderBook(buyData, sellData) {
        // 매도 호가 초기화
        for (let i = 1; i <= 10; i++) {
          const sellElement = document.getElementById(`s_h_${i}`);
          if (sellElement) {
            sellElement.querySelector("#s_h_" + i + "_j").textContent = "";
            sellElement.querySelector("#s_h_" + i + "_price").textContent = "";
            sellElement.querySelector("#s_h_" + i + "_per").textContent = "";
          }
        }

        // 매수 호가 초기화
        for (let i = 1; i <= 10; i++) {
          const buyElement = document.getElementById(`b_h_${i}`);
          if (buyElement) {
            buyElement.querySelector("#b_h_" + i + "_j").textContent = "";
            buyElement.querySelector("#b_h_" + i + "_price").textContent = "";
            buyElement.querySelector("#b_h_" + i + "_per").textContent = "";
          }
        }

        // 매도 호가 업데이트
        for (let i = 0; i < sellData.length; i++) {
          const sellElement = document.getElementById(`s_h_${i + 1}`);
          if (sellElement) {
            const priceElement = sellElement.querySelector(
              "#s_h_" + (i + 1) + "_price"
            );
            const percentElement = sellElement.querySelector(
              "#s_h_" + (i + 1) + "_per"
            );
            const price = sellData[i].price;

            sellElement.querySelector("#s_h_" + (i + 1) + "_j").textContent =
              sellData[i].number;
            priceElement.textContent = price;

            // 퍼센트 계산
            let percent = ((price - 9500) / 9500) * 100;
            if (percent > 0) {
              percentElement.textContent = "+" + percent.toFixed(2) + "%";
            } else {
              percentElement.textContent = percent.toFixed(2) + "%";
            }

            // 가격 및 퍼센트 색상 변경
            if (price > 9500) {
              priceElement.style.color = "#FF0000"; // 빨간색
              percentElement.style.color = "#FF0000";
            } else if (price < 9500) {
              priceElement.style.color = "#0055FF"; // 파란색
              percentElement.style.color = "#0055FF";
            } else {
              priceElement.style.color = "#000000"; // 검은색
              percentElement.style.color = "#000000";
            }
          }
        }

        // 매수 호가 업데이트
        for (let i = 0; i < buyData.length; i++) {
          const buyElement = document.getElementById(`b_h_${i + 1}`);
          if (buyElement) {
            const priceElement = buyElement.querySelector(
              "#b_h_" + (i + 1) + "_price"
            );
            const percentElement = buyElement.querySelector(
              "#b_h_" + (i + 1) + "_per"
            );
            const price = buyData[i].price;

            buyElement.querySelector("#b_h_" + (i + 1) + "_j").textContent =
              buyData[i].number;
            priceElement.textContent = price;

            // 퍼센트 계산
            let percent = ((price - 9500) / 9500) * 100;
            percentElement.textContent = percent.toFixed(2) + "%";

            // 가격 및 퍼센트 색상 변경
            if (price > 9500) {
              priceElement.style.color = "#FF0000"; // 빨간색
              percentElement.style.color = "#FF0000";
            } else if (price < 9500) {
              priceElement.style.color = "#0055FF"; // 파란색
              percentElement.style.color = "#0055FF";
            } else {
              priceElement.style.color = "#000000"; // 검은색
              percentElement.style.color = "#000000";
            }
          }
        }
      }

      function fillMatchData(matchData) {
        const matchList = document.querySelector("#match ul"); // ul 요소 선택
        matchList.innerHTML = ""; // 기존 내용을 지움

        // match 배열을 순회하면서 li 요소를 추가
        matchData.forEach((item) => {
          const li = document.createElement("li"); // li 요소 생성
          const priceSpan = document.createElement("span"); // 가격 span 생성
          const numberSpan = document.createElement("span"); // 수량 span 생성

          // 가격과 수량 설정
          priceSpan.textContent = item.price; // 가격
          numberSpan.textContent = item.number; // 수량

          // 가격 색상 설정
          if (item.price > 9500) {
            priceSpan.style.color = "#FF0000"; // 9500원 이상은 빨간색
          } else if (item.price < 9500) {
            priceSpan.style.color = "#0000FF"; // 9500원 이하(미만)는 파란색
          } else {
            priceSpan.style.color = "#000000"; // 9500원일 때는 검은색
          }

          // number 색상 설정
          if (item.type === "buy") {
            numberSpan.style.color = "#FF0000"; // buy는 빨간색
          } else if (item.type === "sell") {
            numberSpan.style.color = "#0000FF"; // sell은 파란색
          }

          // li에 span 추가
          li.appendChild(priceSpan);
          li.appendChild(numberSpan);
          matchList.appendChild(li); // ul에 li 추가
        });
      }
    </script>
  </body>
</html>
